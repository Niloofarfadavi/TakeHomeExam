<html>
<head>
<title>check_data.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#191a1c">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
check_data.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">imblearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">Pipeline </span><span class="s0">as </span><span class="s1">ImbPipeline</span>
<span class="s0">from </span><span class="s1">imblearn</span><span class="s2">.</span><span class="s1">under_sampling </span><span class="s0">import </span><span class="s1">RandomUnderSampler</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">train_test_split</span><span class="s2">, </span><span class="s1">GridSearchCV</span><span class="s2">, </span><span class="s1">StratifiedKFold</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">RobustScaler</span><span class="s2">, </span><span class="s1">OneHotEncoder</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s1">LogisticRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">ensemble </span><span class="s0">import </span><span class="s1">RandomForestClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">svm </span><span class="s0">import </span><span class="s1">SVC</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">accuracy_score</span><span class="s2">, </span><span class="s1">precision_score</span><span class="s2">, </span><span class="s1">recall_score</span><span class="s2">, </span><span class="s1">confusion_matrix</span>
<span class="s0">from </span><span class="s1">imblearn</span><span class="s2">.</span><span class="s1">over_sampling </span><span class="s0">import </span><span class="s1">RandomOverSampler</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore&quot;</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">FutureWarning</span><span class="s2">)</span>
<span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore&quot;</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># CONFIG</span>
<span class="s4"># =============================================================================</span>
<span class="s1">RANDOM_STATE </span><span class="s2">= </span><span class="s5">42</span>
<span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">RANDOM_STATE</span><span class="s2">)</span>

<span class="s1">NROWS </span><span class="s2">= </span><span class="s5">5000</span>
<span class="s1">UNDERSAMPLE_RATIO </span><span class="s2">= </span><span class="s5">0.5  </span><span class="s4"># minority/majority after undersampling</span>

<span class="s1">data_path </span><span class="s2">= </span><span class="s3">r&quot;data\census-bureau.data&quot;</span>
<span class="s1">cols_path </span><span class="s2">= </span><span class="s3">r&quot;data\census-bureau.columns&quot;</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 1) LOAD RAW DATA</span>
<span class="s4"># =============================================================================</span>
<span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">cols_path</span><span class="s2">, </span><span class="s3">&quot;r&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
    <span class="s1">cols </span><span class="s2">= [</span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">f </span><span class="s0">if </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()]</span>

<span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span>
    <span class="s1">data_path</span><span class="s2">,</span>
    <span class="s1">header</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">names</span><span class="s2">=</span><span class="s1">cols</span><span class="s2">,</span>
    <span class="s1">na_values</span><span class="s2">=</span><span class="s3">&quot;?&quot;</span><span class="s2">,</span>
    <span class="s1">nrows</span><span class="s2">=</span><span class="s1">NROWS</span>
<span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 2) MISSING HANDLING (AS YOU DID)</span>
<span class="s4"># =============================================================================</span>
<span class="s1">low_missing_features </span><span class="s2">= [</span>
    <span class="s3">&quot;hispanic origin&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;state of previous residence&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;country of birth self&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;country of birth mother&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;country of birth father&quot;</span>
<span class="s2">]</span>
<span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">low_missing_features</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">col </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;object&quot;</span><span class="s2">).</span><span class="s1">fillna</span><span class="s2">(</span><span class="s3">&quot;Unknown&quot;</span><span class="s2">)</span>

<span class="s1">migration_cols </span><span class="s2">= [</span>
    <span class="s3">&quot;migration code-change in msa&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;migration code-change in reg&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;migration code-move within reg&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;migration prev res in sunbelt&quot;</span>
<span class="s2">]</span>
<span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">migration_cols</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">c </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s1">c</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s1">c</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;object&quot;</span><span class="s2">).</span><span class="s1">fillna</span><span class="s2">(</span><span class="s3">&quot;Not Applicable&quot;</span><span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 3) ORDINAL ENCODING FOR EDUCATION</span>
<span class="s4"># =============================================================================</span>
<span class="s1">education_alias </span><span class="s2">= {</span>
    <span class="s3">&quot;Some college but no degree&quot;</span><span class="s2">: </span><span class="s3">&quot;Some college&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;Bachelors degree(BA AB BS)&quot;</span><span class="s2">: </span><span class="s3">&quot;Bachelor's degree&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;Masters degree(MA MS MEng MEd MSW MBA)&quot;</span><span class="s2">: </span><span class="s3">&quot;Master's degree&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;Associates degree-academic program&quot;</span><span class="s2">: </span><span class="s3">&quot;Associate's (academic)&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;Associates degree-occup /vocational&quot;</span><span class="s2">: </span><span class="s3">&quot;Associate's (vocational)&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;Prof school degree (MD DDS DVM LLB JD)&quot;</span><span class="s2">: </span><span class="s3">&quot;Professional degree&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;Doctorate degree(PhD EdD)&quot;</span><span class="s2">: </span><span class="s3">&quot;Doctorate degree&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;7th and 8th grade&quot;</span><span class="s2">: </span><span class="s3">&quot;7th-8th grade&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;5th or 6th grade&quot;</span><span class="s2">: </span><span class="s3">&quot;5th-6th grade&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;1st 2nd 3rd or 4th grade&quot;</span><span class="s2">: </span><span class="s3">&quot;1st-4th grade&quot;</span><span class="s2">,</span>
<span class="s2">}</span>
<span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;education_clean&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;education&quot;</span><span class="s2">].</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">education_alias</span><span class="s2">)</span>

<span class="s1">education_map </span><span class="s2">= {</span>
    <span class="s3">&quot;Children&quot;</span><span class="s2">: </span><span class="s5">0</span><span class="s2">,</span>
    <span class="s3">&quot;Less than 1st grade&quot;</span><span class="s2">: </span><span class="s5">1</span><span class="s2">,</span>
    <span class="s3">&quot;1st-4th grade&quot;</span><span class="s2">: </span><span class="s5">2</span><span class="s2">,</span>
    <span class="s3">&quot;5th-6th grade&quot;</span><span class="s2">: </span><span class="s5">3</span><span class="s2">,</span>
    <span class="s3">&quot;7th-8th grade&quot;</span><span class="s2">: </span><span class="s5">4</span><span class="s2">,</span>
    <span class="s3">&quot;9th grade&quot;</span><span class="s2">: </span><span class="s5">5</span><span class="s2">,</span>
    <span class="s3">&quot;10th grade&quot;</span><span class="s2">: </span><span class="s5">6</span><span class="s2">,</span>
    <span class="s3">&quot;11th grade&quot;</span><span class="s2">: </span><span class="s5">7</span><span class="s2">,</span>
    <span class="s3">&quot;12th grade no diploma&quot;</span><span class="s2">: </span><span class="s5">8</span><span class="s2">,</span>
    <span class="s3">&quot;High school graduate&quot;</span><span class="s2">: </span><span class="s5">9</span><span class="s2">,</span>
    <span class="s3">&quot;Some college&quot;</span><span class="s2">: </span><span class="s5">10</span><span class="s2">,</span>
    <span class="s3">&quot;Associate's (vocational)&quot;</span><span class="s2">: </span><span class="s5">11</span><span class="s2">,</span>
    <span class="s3">&quot;Associate's (academic)&quot;</span><span class="s2">: </span><span class="s5">12</span><span class="s2">,</span>
    <span class="s3">&quot;Bachelor's degree&quot;</span><span class="s2">: </span><span class="s5">13</span><span class="s2">,</span>
    <span class="s3">&quot;Master's degree&quot;</span><span class="s2">: </span><span class="s5">14</span><span class="s2">,</span>
    <span class="s3">&quot;Professional degree&quot;</span><span class="s2">: </span><span class="s5">15</span><span class="s2">,</span>
    <span class="s3">&quot;Doctorate degree&quot;</span><span class="s2">: </span><span class="s5">16</span>
<span class="s2">}</span>
<span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;education_ord&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;education_clean&quot;</span><span class="s2">].</span><span class="s1">map</span><span class="s2">(</span><span class="s1">education_map</span><span class="s2">)</span>

<span class="s1">unknown_edu </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;education_ord&quot;</span><span class="s2">].</span><span class="s1">isna</span><span class="s2">(), </span><span class="s3">&quot;education&quot;</span><span class="s2">].</span><span class="s1">unique</span><span class="s2">()</span>
<span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">unknown_edu</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Still unmapped education categories:&quot;</span><span class="s2">, </span><span class="s1">unknown_edu</span><span class="s2">)</span>

<span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;education&quot;</span><span class="s2">, </span><span class="s3">&quot;education_clean&quot;</span><span class="s2">])</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 4) SEPARATE TARGET + WEIGHT</span>
<span class="s4"># =============================================================================</span>
<span class="s1">y_raw </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;label&quot;</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>
<span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;label&quot;</span><span class="s2">])</span>

<span class="s1">weights </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;weight&quot;</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()  </span><span class="s4"># not used in models below, but kept</span>
<span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;weight&quot;</span><span class="s2">])</span>

<span class="s1">y </span><span class="s2">= (</span><span class="s1">y_raw </span><span class="s2">== </span><span class="s3">&quot;50000+.&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 5) ENCODING (SEX BINARY, LOW/MED OHE, HIGH FREQ)</span>
<span class="s4"># =============================================================================</span>
<span class="s4"># 5.1 sex binary</span>
<span class="s1">sex_map </span><span class="s2">= {</span><span class="s3">&quot;Female&quot;</span><span class="s2">: </span><span class="s5">0</span><span class="s2">, </span><span class="s3">&quot;Male&quot;</span><span class="s2">: </span><span class="s5">1</span><span class="s2">}</span>
<span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;sex_encoded&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;sex&quot;</span><span class="s2">].</span><span class="s1">map</span><span class="s2">(</span><span class="s1">sex_map</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
<span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;sex&quot;</span><span class="s2">])</span>

<span class="s4"># 5.2 low-card one-hot (3-9)</span>
<span class="s1">low_card_features </span><span class="s2">= [</span>
    <span class="s3">&quot;enroll in edu inst last wk&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;live in this house 1 year ago&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;member of a labor union&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;migration prev res in sunbelt&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;fill inc questionnaire for veteran's admin&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;own business or self employed&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;veterans benefits&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;citizenship&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;race&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;family members under 18&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;reason for unemployment&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;region of previous residence&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;tax filer stat&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;marital stat&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;detailed household summary in household&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;full or part time employment stat&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;migration code-change in reg&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;class of worker&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;hispanic origin&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;migration code-change in msa&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;migration code-move within reg&quot;</span>
<span class="s2">]</span>
<span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;own business or self employed&quot;</span><span class="s2">, </span><span class="s3">&quot;veterans benefits&quot;</span><span class="s2">]:</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>

<span class="s1">ohe_low </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s3">&quot;first&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
<span class="s1">X_low </span><span class="s2">= </span><span class="s1">ohe_low</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s1">low_card_features</span><span class="s2">])</span>
<span class="s1">low_names </span><span class="s2">= </span><span class="s1">ohe_low</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">low_card_features</span><span class="s2">)</span>
<span class="s1">df_low </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X_low</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">low_names</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
<span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">low_card_features</span><span class="s2">)</span>

<span class="s4"># 5.3 medium-card one-hot (10-20)</span>
<span class="s1">medium_card_features </span><span class="s2">= [</span><span class="s3">&quot;major occupation code&quot;</span><span class="s2">]</span>
<span class="s1">ohe_med </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s3">&quot;first&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
<span class="s1">X_med </span><span class="s2">= </span><span class="s1">ohe_med</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s1">medium_card_features</span><span class="s2">])</span>
<span class="s1">med_names </span><span class="s2">= </span><span class="s1">ohe_med</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">medium_card_features</span><span class="s2">)</span>
<span class="s1">df_med </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X_med</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">med_names</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
<span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">medium_card_features</span><span class="s2">)</span>

<span class="s4"># 5.4 high-card frequency (21+)</span>
<span class="s1">high_card_features </span><span class="s2">= [</span>
    <span class="s3">&quot;major industry code&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;detailed household and family stat&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;country of birth self&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;country of birth father&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;country of birth mother&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;detailed occupation recode&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;detailed industry recode&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;state of previous residence&quot;</span>
<span class="s2">]</span>
<span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;detailed occupation recode&quot;</span><span class="s2">, </span><span class="s3">&quot;detailed industry recode&quot;</span><span class="s2">]:</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>

<span class="s1">df_freq </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
<span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">high_card_features</span><span class="s2">:</span>
    <span class="s1">freq_map </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">value_counts</span><span class="s2">(</span><span class="s1">normalize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">to_dict</span><span class="s2">()</span>
    <span class="s1">df_freq</span><span class="s2">[</span><span class="s1">col </span><span class="s2">+ </span><span class="s3">&quot;_freq&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">map</span><span class="s2">(</span><span class="s1">freq_map</span><span class="s2">).</span><span class="s1">fillna</span><span class="s2">(</span><span class="s5">0.0</span><span class="s2">)</span>

<span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">high_card_features</span><span class="s2">)</span>

<span class="s4"># 5.5 numeric keep</span>
<span class="s1">numeric_features_keep </span><span class="s2">= [</span>
    <span class="s3">&quot;age&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;wage per hour&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;capital gains&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;capital losses&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;dividends from stocks&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;num persons worked for employer&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;weeks worked in year&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;year&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;education_ord&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;sex_encoded&quot;</span>
<span class="s2">]</span>
<span class="s1">df_num </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">numeric_features_keep</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>

<span class="s4"># 5.6 final matrix</span>
<span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">df_num</span><span class="s2">, </span><span class="s1">df_low</span><span class="s2">, </span><span class="s1">df_med</span><span class="s2">, </span><span class="s1">df_freq</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>

<span class="s4"># final missing check</span>
<span class="s0">if </span><span class="s1">X</span><span class="s2">.</span><span class="s1">isna</span><span class="s2">().</span><span class="s1">sum</span><span class="s2">().</span><span class="s1">sum</span><span class="s2">() != </span><span class="s5">0</span><span class="s2">:</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Missing exists after preprocessing:&quot;</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">isna</span><span class="s2">().</span><span class="s1">sum</span><span class="s2">()[</span><span class="s1">X</span><span class="s2">.</span><span class="s1">isna</span><span class="s2">().</span><span class="s1">sum</span><span class="s2">() &gt; </span><span class="s5">0</span><span class="s2">])</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">80</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;DATA READY&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">80</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;X shape:&quot;</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;y distribution:&quot;</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">value_counts</span><span class="s2">().</span><span class="s1">to_dict</span><span class="s2">())</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 6) TRAIN / TEST SPLIT (TEST UNTOUCHED)</span>
<span class="s4"># =============================================================================</span>
<span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">,</span>
    <span class="s1">test_size</span><span class="s2">=</span><span class="s5">0.2</span><span class="s2">,</span>
    <span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">,</span>
    <span class="s1">stratify</span><span class="s2">=</span><span class="s1">y</span>
<span class="s2">)</span>

<span class="s1">cv </span><span class="s2">= </span><span class="s1">StratifiedKFold</span><span class="s2">(</span><span class="s1">n_splits</span><span class="s2">=</span><span class="s5">5</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">)</span>
<span class="s4">#rus = RandomUnderSampler(sampling_strategy=UNDERSAMPLE_RATIO, random_state=RANDOM_STATE)</span>
<span class="s1">rus </span><span class="s2">= </span><span class="s1">RandomOverSampler</span><span class="s2">(</span><span class="s1">sampling_strategy</span><span class="s2">=</span><span class="s3">'auto'</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">)</span>
<span class="s1">results </span><span class="s2">= {}</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 7) MODELS (PRECISION-OPTIMIZED)</span>
<span class="s4"># =============================================================================</span>

<span class="s4"># --- Logistic Regression (RUS inside CV) ---</span>
<span class="s1">lr_pipe </span><span class="s2">= </span><span class="s1">ImbPipeline</span><span class="s2">(</span><span class="s1">steps</span><span class="s2">=[</span>
    <span class="s2">(</span><span class="s3">&quot;rus&quot;</span><span class="s2">, </span><span class="s1">rus</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">&quot;scaler&quot;</span><span class="s2">, </span><span class="s1">RobustScaler</span><span class="s2">()),</span>
    <span class="s2">(</span><span class="s3">&quot;model&quot;</span><span class="s2">, </span><span class="s1">LogisticRegression</span><span class="s2">(</span><span class="s1">max_iter</span><span class="s2">=</span><span class="s5">5000</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">))</span>
<span class="s2">])</span>

<span class="s1">lr_grid </span><span class="s2">= {</span>
    <span class="s3">&quot;model__C&quot;</span><span class="s2">: [</span><span class="s5">0.001</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
    <span class="s3">&quot;model__solver&quot;</span><span class="s2">: [</span><span class="s3">&quot;liblinear&quot;</span><span class="s2">],</span>
    <span class="s3">&quot;model__penalty&quot;</span><span class="s2">: [</span><span class="s3">&quot;l2&quot;</span><span class="s2">],</span>
    <span class="s3">&quot;model__class_weight&quot;</span><span class="s2">: [</span><span class="s0">None</span><span class="s2">]</span>
<span class="s2">}</span>

<span class="s1">lr_search </span><span class="s2">= </span><span class="s1">GridSearchCV</span><span class="s2">(</span><span class="s1">lr_pipe</span><span class="s2">, </span><span class="s1">lr_grid</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s1">cv</span><span class="s2">, </span><span class="s1">scoring</span><span class="s2">=</span><span class="s3">&quot;precision&quot;</span><span class="s2">, </span><span class="s1">n_jobs</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
<span class="s1">lr_search</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
<span class="s1">lr_best </span><span class="s2">= </span><span class="s1">lr_search</span><span class="s2">.</span><span class="s1">best_estimator_</span>
<span class="s1">yp </span><span class="s2">= </span><span class="s1">lr_best</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

<span class="s1">results</span><span class="s2">[</span><span class="s3">&quot;LR_RUS&quot;</span><span class="s2">] = {</span>
    <span class="s3">&quot;best_params&quot;</span><span class="s2">: </span><span class="s1">lr_search</span><span class="s2">.</span><span class="s1">best_params_</span><span class="s2">,</span>
    <span class="s3">&quot;accuracy&quot;</span><span class="s2">: </span><span class="s1">accuracy_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">),</span>
    <span class="s3">&quot;precision&quot;</span><span class="s2">: </span><span class="s1">precision_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">, </span><span class="s1">zero_division</span><span class="s2">=</span><span class="s5">0</span><span class="s2">),</span>
    <span class="s3">&quot;recall&quot;</span><span class="s2">: </span><span class="s1">recall_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">, </span><span class="s1">zero_division</span><span class="s2">=</span><span class="s5">0</span><span class="s2">),</span>
    <span class="s3">&quot;cm&quot;</span><span class="s2">: </span><span class="s1">confusion_matrix</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">)</span>
<span class="s2">}</span>

<span class="s4"># --- Random Forest (RUS inside CV) ---</span>
<span class="s1">rf_pipe </span><span class="s2">= </span><span class="s1">ImbPipeline</span><span class="s2">(</span><span class="s1">steps</span><span class="s2">=[</span>
    <span class="s2">(</span><span class="s3">&quot;rus&quot;</span><span class="s2">, </span><span class="s1">rus</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">&quot;model&quot;</span><span class="s2">, </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">))</span>
<span class="s2">])</span>

<span class="s1">rf_grid </span><span class="s2">= {</span>
    <span class="s3">&quot;model__n_estimators&quot;</span><span class="s2">: [</span><span class="s5">100</span><span class="s2">, </span><span class="s5">200</span><span class="s2">, </span><span class="s5">500</span><span class="s2">],</span>
    <span class="s3">&quot;model__max_depth&quot;</span><span class="s2">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
    <span class="s3">&quot;model__min_samples_split&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">],</span>
    <span class="s3">&quot;model__min_samples_leaf&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">],</span>
    <span class="s3">&quot;model__max_features&quot;</span><span class="s2">: [</span><span class="s3">&quot;sqrt&quot;</span><span class="s2">, </span><span class="s3">&quot;log2&quot;</span><span class="s2">],</span>
    <span class="s3">&quot;model__class_weight&quot;</span><span class="s2">: [</span><span class="s0">None</span><span class="s2">]</span>
<span class="s2">}</span>

<span class="s1">rf_search </span><span class="s2">= </span><span class="s1">GridSearchCV</span><span class="s2">(</span><span class="s1">rf_pipe</span><span class="s2">, </span><span class="s1">rf_grid</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s1">cv</span><span class="s2">, </span><span class="s1">scoring</span><span class="s2">=</span><span class="s3">&quot;precision&quot;</span><span class="s2">, </span><span class="s1">n_jobs</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
<span class="s1">rf_search</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
<span class="s1">rf_best </span><span class="s2">= </span><span class="s1">rf_search</span><span class="s2">.</span><span class="s1">best_estimator_</span>
<span class="s1">yp </span><span class="s2">= </span><span class="s1">rf_best</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

<span class="s1">results</span><span class="s2">[</span><span class="s3">&quot;RF_RUS&quot;</span><span class="s2">] = {</span>
    <span class="s3">&quot;best_params&quot;</span><span class="s2">: </span><span class="s1">rf_search</span><span class="s2">.</span><span class="s1">best_params_</span><span class="s2">,</span>
    <span class="s3">&quot;accuracy&quot;</span><span class="s2">: </span><span class="s1">accuracy_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">),</span>
    <span class="s3">&quot;precision&quot;</span><span class="s2">: </span><span class="s1">precision_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">, </span><span class="s1">zero_division</span><span class="s2">=</span><span class="s5">0</span><span class="s2">),</span>
    <span class="s3">&quot;recall&quot;</span><span class="s2">: </span><span class="s1">recall_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">, </span><span class="s1">zero_division</span><span class="s2">=</span><span class="s5">0</span><span class="s2">),</span>
    <span class="s3">&quot;cm&quot;</span><span class="s2">: </span><span class="s1">confusion_matrix</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">)</span>
<span class="s2">}</span>

<span class="s4"># --- SVM (RUS inside CV) ---</span>
<span class="s1">svm_pipe </span><span class="s2">= </span><span class="s1">ImbPipeline</span><span class="s2">(</span><span class="s1">steps</span><span class="s2">=[</span>
    <span class="s2">(</span><span class="s3">&quot;rus&quot;</span><span class="s2">, </span><span class="s1">rus</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">&quot;scaler&quot;</span><span class="s2">, </span><span class="s1">RobustScaler</span><span class="s2">()),</span>
    <span class="s2">(</span><span class="s3">&quot;model&quot;</span><span class="s2">, </span><span class="s1">SVC</span><span class="s2">(</span><span class="s1">probability</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">))</span>
<span class="s2">])</span>

<span class="s1">svm_grid </span><span class="s2">= {</span>
    <span class="s3">&quot;model__C&quot;</span><span class="s2">: [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
    <span class="s3">&quot;model__gamma&quot;</span><span class="s2">: [</span><span class="s3">&quot;scale&quot;</span><span class="s2">, </span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s5">0.001</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
    <span class="s3">&quot;model__kernel&quot;</span><span class="s2">: [</span><span class="s3">&quot;rbf&quot;</span><span class="s2">],</span>
    <span class="s3">&quot;model__class_weight&quot;</span><span class="s2">: [</span><span class="s0">None</span><span class="s2">]</span>
<span class="s2">}</span>

<span class="s1">svm_search </span><span class="s2">= </span><span class="s1">GridSearchCV</span><span class="s2">(</span><span class="s1">svm_pipe</span><span class="s2">, </span><span class="s1">svm_grid</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s1">cv</span><span class="s2">, </span><span class="s1">scoring</span><span class="s2">=</span><span class="s3">&quot;precision&quot;</span><span class="s2">, </span><span class="s1">n_jobs</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
<span class="s1">svm_search</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
<span class="s1">svm_best </span><span class="s2">= </span><span class="s1">svm_search</span><span class="s2">.</span><span class="s1">best_estimator_</span>
<span class="s1">yp </span><span class="s2">= </span><span class="s1">svm_best</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

<span class="s1">results</span><span class="s2">[</span><span class="s3">&quot;SVM_RUS&quot;</span><span class="s2">] = {</span>
    <span class="s3">&quot;best_params&quot;</span><span class="s2">: </span><span class="s1">svm_search</span><span class="s2">.</span><span class="s1">best_params_</span><span class="s2">,</span>
    <span class="s3">&quot;accuracy&quot;</span><span class="s2">: </span><span class="s1">accuracy_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">),</span>
    <span class="s3">&quot;precision&quot;</span><span class="s2">: </span><span class="s1">precision_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">, </span><span class="s1">zero_division</span><span class="s2">=</span><span class="s5">0</span><span class="s2">),</span>
    <span class="s3">&quot;recall&quot;</span><span class="s2">: </span><span class="s1">recall_score</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">, </span><span class="s1">zero_division</span><span class="s2">=</span><span class="s5">0</span><span class="s2">),</span>
    <span class="s3">&quot;cm&quot;</span><span class="s2">: </span><span class="s1">confusion_matrix</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">)</span>
<span class="s2">}</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># 8) PRINT RESULTS</span>
<span class="s4"># =============================================================================</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">+ </span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">80</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;TEST RESULTS (PRECISION-OPTIMIZED)&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">80</span><span class="s2">)</span>

<span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">results</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;best_params:&quot;</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[</span><span class="s3">&quot;best_params&quot;</span><span class="s2">])</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;accuracy : </span><span class="s0">{</span><span class="s1">v</span><span class="s2">[</span><span class="s3">'accuracy'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.4f</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;precision: </span><span class="s0">{</span><span class="s1">v</span><span class="s2">[</span><span class="s3">'precision'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.4f</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;recall   : </span><span class="s0">{</span><span class="s1">v</span><span class="s2">[</span><span class="s3">'recall'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.4f</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;cm:</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[</span><span class="s3">&quot;cm&quot;</span><span class="s2">])</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># STEP 1: FEATURE SELECTION FOR SEGMENTATION</span>
<span class="s4"># =============================================================================</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">--- Step 1: Feature Selection for Segmentation ---&quot;</span><span class="s2">)</span>

<span class="s4"># Select meaningful features for marketing segmentation</span>
<span class="s4"># Focus on: Demographics, Income, Employment, Household</span>

<span class="s1">segmentation_features </span><span class="s2">= [</span>
    <span class="s4"># Demographics</span>
    <span class="s3">'age'</span><span class="s2">,</span>
    <span class="s3">'education_ord'</span><span class="s2">,</span>
    <span class="s3">'sex_encoded'</span><span class="s2">,</span>

    <span class="s4"># Income &amp; Wealth</span>
    <span class="s3">'capital gains'</span><span class="s2">,</span>
    <span class="s3">'capital losses'</span><span class="s2">,</span>
    <span class="s3">'dividends from stocks'</span><span class="s2">,</span>

    <span class="s4"># Employment</span>
    <span class="s3">'weeks worked in year'</span><span class="s2">,</span>
    <span class="s3">'num persons worked for employer'</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">X_seg_base </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s1">segmentation_features</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>

<span class="s4"># Add aggregated categorical features</span>
<span class="s4"># Marital status (married vs not married)</span>
<span class="s1">marital_cols </span><span class="s2">= [</span><span class="s1">col </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">X</span><span class="s2">.</span><span class="s1">columns </span><span class="s0">if </span><span class="s1">col</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'marital stat_'</span><span class="s2">)]</span>
<span class="s1">married_cols </span><span class="s2">= [</span><span class="s1">col </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">marital_cols </span><span class="s0">if </span><span class="s3">'Married' </span><span class="s0">in </span><span class="s1">col</span><span class="s2">]</span>
<span class="s1">X_seg_base</span><span class="s2">[</span><span class="s3">'is_married'</span><span class="s2">] = </span><span class="s1">X</span><span class="s2">[</span><span class="s1">married_cols</span><span class="s2">].</span><span class="s1">max</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">) </span><span class="s0">if </span><span class="s1">married_cols </span><span class="s0">else </span><span class="s5">0</span>

<span class="s4"># Employment status (full-time vs other)</span>
<span class="s1">employment_cols </span><span class="s2">= [</span><span class="s1">col </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">X</span><span class="s2">.</span><span class="s1">columns </span><span class="s0">if </span><span class="s1">col</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'full or part time employment stat_'</span><span class="s2">)]</span>
<span class="s1">fulltime_cols </span><span class="s2">= [</span><span class="s1">col </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">employment_cols </span><span class="s0">if </span><span class="s3">'Full-time' </span><span class="s0">in </span><span class="s1">col</span><span class="s2">]</span>
<span class="s1">X_seg_base</span><span class="s2">[</span><span class="s3">'is_employed_full_time'</span><span class="s2">] = </span><span class="s1">X</span><span class="s2">[</span><span class="s1">fulltime_cols</span><span class="s2">].</span><span class="s1">max</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">) </span><span class="s0">if </span><span class="s1">fulltime_cols </span><span class="s0">else </span><span class="s5">0</span>

<span class="s4"># Derived features</span>
<span class="s1">X_seg_base</span><span class="s2">[</span><span class="s3">'has_capital_income'</span><span class="s2">] = ((</span><span class="s1">X</span><span class="s2">[</span><span class="s3">'capital gains'</span><span class="s2">] &gt; </span><span class="s5">0</span><span class="s2">) |</span>
                                    <span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s3">'dividends from stocks'</span><span class="s2">] &gt; </span><span class="s5">0</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
<span class="s1">X_seg_base</span><span class="s2">[</span><span class="s3">'high_education'</span><span class="s2">] = (</span><span class="s1">X</span><span class="s2">[</span><span class="s3">'education_ord'</span><span class="s2">] &gt;= </span><span class="s5">13</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)  </span><span class="s4"># Bachelor's+</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;Selected </span><span class="s0">{</span><span class="s1">X_seg_base</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span><span class="s0">} </span><span class="s3">features for segmentation&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;Features: </span><span class="s0">{</span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_seg_base</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

<span class="s4"># Now standardize only these selected features</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">StandardScaler</span>

<span class="s1">scaler </span><span class="s2">= </span><span class="s1">StandardScaler</span><span class="s2">()</span>
<span class="s1">X_seg </span><span class="s2">= </span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_seg_base</span><span class="s2">)</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Features standardized for clustering&quot;</span><span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># STEP 2: DETERMINE OPTIMAL NUMBER OF CLUSTERS</span>
<span class="s4"># =============================================================================</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">--- Step 2: Determining Optimal Number of Clusters ---&quot;</span><span class="s2">)</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">cluster </span><span class="s0">import </span><span class="s1">KMeans</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">silhouette_score</span><span class="s2">, </span><span class="s1">davies_bouldin_score</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>

<span class="s4"># Test different numbers of clusters (K)</span>
<span class="s1">K_range </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">11</span><span class="s2">)  </span><span class="s4"># Test K from 2 to 10</span>
<span class="s1">inertias </span><span class="s2">= []</span>
<span class="s1">silhouettes </span><span class="s2">= []</span>
<span class="s1">davies_bouldins </span><span class="s2">= []</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Testing different values of K...&quot;</span><span class="s2">)</span>
<span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">K_range</span><span class="s2">:</span>
    <span class="s1">kmeans </span><span class="s2">= </span><span class="s1">KMeans</span><span class="s2">(</span><span class="s1">n_clusters</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">, </span><span class="s1">n_init</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">labels </span><span class="s2">= </span><span class="s1">kmeans</span><span class="s2">.</span><span class="s1">fit_predict</span><span class="s2">(</span><span class="s1">X_seg</span><span class="s2">)</span>

    <span class="s1">inertias</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">kmeans</span><span class="s2">.</span><span class="s1">inertia_</span><span class="s2">)</span>
    <span class="s1">silhouettes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">silhouette_score</span><span class="s2">(</span><span class="s1">X_seg</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">))</span>
    <span class="s1">davies_bouldins</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">davies_bouldin_score</span><span class="s2">(</span><span class="s1">X_seg</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">))</span>

    <span class="s1">print</span><span class="s2">(</span>
        <span class="s3">f&quot;K=</span><span class="s0">{</span><span class="s1">k</span><span class="s0">}</span><span class="s3">: Inertia=</span><span class="s0">{</span><span class="s1">kmeans</span><span class="s2">.</span><span class="s1">inertia_</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">, Silhouette=</span><span class="s0">{</span><span class="s1">silhouettes</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.3f</span><span class="s0">}</span><span class="s3">, Davies-Bouldin=</span><span class="s0">{</span><span class="s1">davies_bouldins</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.3f</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

<span class="s4"># Find optimal K based on different metrics</span>
<span class="s1">optimal_k_silhouette </span><span class="s2">= </span><span class="s1">K_range</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">silhouettes</span><span class="s2">)]</span>
<span class="s1">optimal_k_db </span><span class="s2">= </span><span class="s1">K_range</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmin</span><span class="s2">(</span><span class="s1">davies_bouldins</span><span class="s2">)]</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n</span><span class="s3">Optimal K based on Silhouette Score: </span><span class="s0">{</span><span class="s1">optimal_k_silhouette</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;Optimal K based on Davies-Bouldin Index: </span><span class="s0">{</span><span class="s1">optimal_k_db</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

<span class="s4"># Create visualization</span>
<span class="s1">fig</span><span class="s2">, </span><span class="s1">axes </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s5">18</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>

<span class="s4"># Plot 1: Elbow Method (Inertia)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">K_range</span><span class="s2">, </span><span class="s1">inertias</span><span class="s2">, </span><span class="s3">'bo-'</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">markersize</span><span class="s2">=</span><span class="s5">8</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Number of Clusters (K)'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'Inertia (Within-cluster sum of squares)'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Elbow Method'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">14</span><span class="s2">, </span><span class="s1">fontweight</span><span class="s2">=</span><span class="s3">'bold'</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">grid</span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.3</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">set_xticks</span><span class="s2">(</span><span class="s1">K_range</span><span class="s2">)</span>

<span class="s4"># Plot 2: Silhouette Score (higher is better)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">K_range</span><span class="s2">, </span><span class="s1">silhouettes</span><span class="s2">, </span><span class="s3">'go-'</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">markersize</span><span class="s2">=</span><span class="s5">8</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">axvline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">optimal_k_silhouette</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'red'</span><span class="s2">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s3">'--'</span><span class="s2">, </span><span class="s1">label</span><span class="s2">=</span><span class="s3">f'Optimal K=</span><span class="s0">{</span><span class="s1">optimal_k_silhouette</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Number of Clusters (K)'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'Silhouette Score (higher is better)'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Silhouette Analysis'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">14</span><span class="s2">, </span><span class="s1">fontweight</span><span class="s2">=</span><span class="s3">'bold'</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">grid</span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.3</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">set_xticks</span><span class="s2">(</span><span class="s1">K_range</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">legend</span><span class="s2">()</span>

<span class="s4"># Plot 3: Davies-Bouldin Index (lower is better)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">K_range</span><span class="s2">, </span><span class="s1">davies_bouldins</span><span class="s2">, </span><span class="s3">'ro-'</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">markersize</span><span class="s2">=</span><span class="s5">8</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">axvline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">optimal_k_db</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'green'</span><span class="s2">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s3">'--'</span><span class="s2">, </span><span class="s1">label</span><span class="s2">=</span><span class="s3">f'Optimal K=</span><span class="s0">{</span><span class="s1">optimal_k_db</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Number of Clusters (K)'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'Davies-Bouldin Index (lower is better)'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Davies-Bouldin Analysis'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">14</span><span class="s2">, </span><span class="s1">fontweight</span><span class="s2">=</span><span class="s3">'bold'</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">grid</span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.3</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">set_xticks</span><span class="s2">(</span><span class="s1">K_range</span><span class="s2">)</span>
<span class="s1">axes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">legend</span><span class="s2">()</span>

<span class="s1">plt</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>
<span class="s1">plt</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s3">'data/cluster_optimization.png'</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">=</span><span class="s5">300</span><span class="s2">, </span><span class="s1">bbox_inches</span><span class="s2">=</span><span class="s3">'tight'</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">Cluster optimization plot saved: data/cluster_optimization.png&quot;</span><span class="s2">)</span>
<span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

<span class="s4"># Choose final K (you can adjust this based on business needs)</span>
<span class="s4"># For marketing, 4-6 segments are typically manageable</span>
<span class="s1">FINAL_K </span><span class="s2">= </span><span class="s5">5  </span><span class="s4"># You can change this based on the plots</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n</span><span class="s3">Selected K=</span><span class="s0">{</span><span class="s1">FINAL_K</span><span class="s0">} </span><span class="s3">for final segmentation&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;(Balancing statistical quality with business manageability)&quot;</span><span class="s2">)</span>
<span class="s4"># =============================================================================</span>
<span class="s4"># STEP 3: CREATE FINAL SEGMENTS</span>
<span class="s4"># =============================================================================</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">--- Step 3: Creating Final Customer Segments ---&quot;</span><span class="s2">)</span>

<span class="s4"># Apply K-Means with final K</span>
<span class="s1">FINAL_K </span><span class="s2">= </span><span class="s5">4</span>
<span class="s1">kmeans_final </span><span class="s2">= </span><span class="s1">KMeans</span><span class="s2">(</span><span class="s1">n_clusters</span><span class="s2">=</span><span class="s1">FINAL_K</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">RANDOM_STATE</span><span class="s2">, </span><span class="s1">n_init</span><span class="s2">=</span><span class="s5">20</span><span class="s2">)</span>
<span class="s1">clusters </span><span class="s2">= </span><span class="s1">kmeans_final</span><span class="s2">.</span><span class="s1">fit_predict</span><span class="s2">(</span><span class="s1">X_seg</span><span class="s2">)</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n</span><span class="s3">Created </span><span class="s0">{</span><span class="s1">FINAL_K</span><span class="s0">} </span><span class="s3">customer segments&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n</span><span class="s3">Segment Distribution:&quot;</span><span class="s2">)</span>
<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">FINAL_K</span><span class="s2">):</span>
    <span class="s1">count </span><span class="s2">= (</span><span class="s1">clusters </span><span class="s2">== </span><span class="s1">i</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">pct </span><span class="s2">= </span><span class="s1">count </span><span class="s2">/ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">clusters</span><span class="s2">) * </span><span class="s5">100</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;  Segment </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">: </span><span class="s0">{</span><span class="s1">count</span><span class="s0">:</span><span class="s3">,</span><span class="s0">} </span><span class="s3">customers (</span><span class="s0">{</span><span class="s1">pct</span><span class="s0">:</span><span class="s3">.1f</span><span class="s0">}</span><span class="s3">%)&quot;</span><span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># STEP 4: SEGMENT PROFILING (Map back to original features)</span>
<span class="s4"># =============================================================================</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">--- Step 4: Segment Profiling ---&quot;</span><span class="s2">)</span>

<span class="s4"># Create profiling dataset with original features + segment labels</span>
<span class="s1">X_profiling </span><span class="s2">= </span><span class="s1">X_seg_base</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()  </span><span class="s4"># Use the un-scaled features for interpretation</span>
<span class="s1">X_profiling</span><span class="s2">[</span><span class="s3">'Segment'</span><span class="s2">] = </span><span class="s1">clusters</span>
<span class="s1">X_profiling</span><span class="s2">[</span><span class="s3">'Income_50K+'</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">.</span><span class="s1">values</span>

<span class="s4"># Calculate profile statistics for each segment</span>
<span class="s1">segment_profiles </span><span class="s2">= []</span>

<span class="s0">for </span><span class="s1">seg </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">FINAL_K</span><span class="s2">):</span>
    <span class="s1">seg_data </span><span class="s2">= </span><span class="s1">X_profiling</span><span class="s2">[</span><span class="s1">X_profiling</span><span class="s2">[</span><span class="s3">'Segment'</span><span class="s2">] == </span><span class="s1">seg</span><span class="s2">]</span>

    <span class="s1">profile </span><span class="s2">= {</span>
        <span class="s3">'Segment'</span><span class="s2">: </span><span class="s3">f'Segment </span><span class="s0">{</span><span class="s1">seg</span><span class="s0">}</span><span class="s3">'</span><span class="s2">,</span>
        <span class="s3">'Size'</span><span class="s2">: </span><span class="s1">len</span><span class="s2">(</span><span class="s1">seg_data</span><span class="s2">),</span>
        <span class="s3">'Size_Pct'</span><span class="s2">: </span><span class="s1">len</span><span class="s2">(</span><span class="s1">seg_data</span><span class="s2">) / </span><span class="s1">len</span><span class="s2">(</span><span class="s1">X_profiling</span><span class="s2">) * </span><span class="s5">100</span><span class="s2">,</span>
        <span class="s3">'Avg_Age'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'age'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
        <span class="s3">'Avg_Education'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'education_ord'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
        <span class="s3">'Pct_Male'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'sex_encoded'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">() * </span><span class="s5">100</span><span class="s2">,</span>
        <span class="s3">'Pct_Married'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'is_married'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">() * </span><span class="s5">100</span><span class="s2">,</span>
        <span class="s3">'Pct_FullTime'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'is_employed_full_time'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">() * </span><span class="s5">100</span><span class="s2">,</span>
        <span class="s3">'Pct_HighEd'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'high_education'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">() * </span><span class="s5">100</span><span class="s2">,</span>
        <span class="s3">'Avg_CapitalGains'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'capital gains'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
        <span class="s3">'Avg_Dividends'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'dividends from stocks'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
        <span class="s3">'Pct_HasCapital'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'has_capital_income'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">() * </span><span class="s5">100</span><span class="s2">,</span>
        <span class="s3">'Avg_WeeksWorked'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'weeks worked in year'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
        <span class="s3">'Avg_NumEmployers'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'num persons worked for employer'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
        <span class="s3">'Pct_Income50K'</span><span class="s2">: </span><span class="s1">seg_data</span><span class="s2">[</span><span class="s3">'Income_50K+'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">() * </span><span class="s5">100</span>
    <span class="s2">}</span>

    <span class="s1">segment_profiles</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">profile</span><span class="s2">)</span>

<span class="s4"># Create DataFrame</span>
<span class="s1">df_profiles </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">segment_profiles</span><span class="s2">)</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">+ </span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">100</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;SEGMENT PROFILES&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">100</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s1">df_profiles</span><span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s5">1</span><span class="s2">).</span><span class="s1">to_string</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>

<span class="s4"># Save profiles</span>
<span class="s1">df_profiles</span><span class="s2">.</span><span class="s1">to_csv</span><span class="s2">(</span><span class="s3">'data/segment_profiles.csv'</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">Segment profiles saved: data/segment_profiles.csv&quot;</span><span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># STEP 5: SEGMENT CHARACTERIZATION (Give descriptive names)</span>
<span class="s4"># =============================================================================</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">--- Step 5: Segment Characterization ---&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">+ </span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">100</span><span class="s2">)</span>

<span class="s1">segment_names </span><span class="s2">= []</span>
<span class="s1">segment_descriptions </span><span class="s2">= []</span>

<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">FINAL_K</span><span class="s2">):</span>
    <span class="s1">profile </span><span class="s2">= </span><span class="s1">segment_profiles</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

    <span class="s4"># Determine age group</span>
    <span class="s1">age </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Avg_Age'</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">age </span><span class="s2">&lt; </span><span class="s5">25</span><span class="s2">:</span>
        <span class="s1">age_group </span><span class="s2">= </span><span class="s3">&quot;Young&quot;</span>
    <span class="s0">elif </span><span class="s1">age </span><span class="s2">&lt; </span><span class="s5">45</span><span class="s2">:</span>
        <span class="s1">age_group </span><span class="s2">= </span><span class="s3">&quot;Mid-Career&quot;</span>
    <span class="s0">elif </span><span class="s1">age </span><span class="s2">&lt; </span><span class="s5">65</span><span class="s2">:</span>
        <span class="s1">age_group </span><span class="s2">= </span><span class="s3">&quot;Established&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">age_group </span><span class="s2">= </span><span class="s3">&quot;Senior&quot;</span>

    <span class="s4"># Determine income/wealth level</span>
    <span class="s1">high_income_pct </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_Income50K'</span><span class="s2">]</span>
    <span class="s1">capital_pct </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_HasCapital'</span><span class="s2">]</span>

    <span class="s0">if </span><span class="s1">high_income_pct </span><span class="s2">&gt; </span><span class="s5">15 </span><span class="s0">and </span><span class="s1">capital_pct </span><span class="s2">&gt; </span><span class="s5">15</span><span class="s2">:</span>
        <span class="s1">wealth </span><span class="s2">= </span><span class="s3">&quot;Affluent&quot;</span>
    <span class="s0">elif </span><span class="s1">high_income_pct </span><span class="s2">&gt; </span><span class="s5">10 </span><span class="s0">or </span><span class="s1">capital_pct </span><span class="s2">&gt; </span><span class="s5">5</span><span class="s2">:</span>
        <span class="s1">wealth </span><span class="s2">= </span><span class="s3">&quot;Moderate-Income&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">wealth </span><span class="s2">= </span><span class="s3">&quot;Mass-Market&quot;</span>

    <span class="s4"># Determine education level</span>
    <span class="s0">if </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_HighEd'</span><span class="s2">] &gt; </span><span class="s5">30</span><span class="s2">:</span>
        <span class="s1">education </span><span class="s2">= </span><span class="s3">&quot;Highly-Educated&quot;</span>
    <span class="s0">elif </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_HighEd'</span><span class="s2">] &gt; </span><span class="s5">15</span><span class="s2">:</span>
        <span class="s1">education </span><span class="s2">= </span><span class="s3">&quot;Educated&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">education </span><span class="s2">= </span><span class="s3">&quot;General-Education&quot;</span>

    <span class="s4"># Combine characteristics</span>
    <span class="s1">name </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">age_group</span><span class="s0">} {</span><span class="s1">wealth</span><span class="s0">} {</span><span class="s1">education</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s1">segment_names</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s4"># Create detailed description</span>
    <span class="s1">description </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;</span>
<span class="s3">SEGMENT </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">: </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span>
<span class="s0">{</span><span class="s3">'=' </span><span class="s2">* </span><span class="s5">100</span><span class="s0">}</span>
<span class="s3">Size: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Size'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">,</span><span class="s0">} </span><span class="s3">customers (</span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Size_Pct'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.1f</span><span class="s0">}</span><span class="s3">% of total)</span>

<span class="s3">Demographics:</span>
  <span class="s3">- Average Age: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Avg_Age'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">} </span><span class="s3">years</span>
  <span class="s3">- Gender: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_Male'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% Male, </span><span class="s0">{</span><span class="s5">100 </span><span class="s2">- </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_Male'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% Female</span>
  <span class="s3">- Marital Status: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_Married'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% Married</span>
  <span class="s3">- Education: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_HighEd'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% have Bachelor's degree or higher</span>

<span class="s3">Economic Characteristics:</span>
  <span class="s3">- Income: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_Income50K'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.1f</span><span class="s0">}</span><span class="s3">% earn over $50,000 annually</span>
  <span class="s3">- Capital Income: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_HasCapital'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% have investment income</span>
  <span class="s3">- Average Capital Gains: $</span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Avg_CapitalGains'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">,.0f</span><span class="s0">}</span>
  <span class="s3">- Average Dividends: $</span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Avg_Dividends'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">,.0f</span><span class="s0">}</span>

<span class="s3">Employment:</span>
  <span class="s3">- Full-time Employment: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_FullTime'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">%</span>
  <span class="s3">- Average Weeks Worked: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Avg_WeeksWorked'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.1f</span><span class="s0">} </span><span class="s3">weeks/year</span>
  <span class="s3">- Average Employers: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Avg_NumEmployers'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.1f</span><span class="s0">}</span>
<span class="s3">&quot;&quot;&quot;</span>

    <span class="s1">segment_descriptions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">description</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">description</span><span class="s2">)</span>

<span class="s4"># Save segment names and descriptions</span>
<span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s3">'data/segment_descriptions.txt'</span><span class="s2">, </span><span class="s3">'w'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
    <span class="s0">for </span><span class="s1">desc </span><span class="s0">in </span><span class="s1">segment_descriptions</span><span class="s2">:</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">desc </span><span class="s2">+ </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">)</span>

<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">Segment descriptions saved: data/segment_descriptions.txt&quot;</span><span class="s2">)</span>

<span class="s4"># =============================================================================</span>
<span class="s4"># STEP 6: MARKETING RECOMMENDATIONS BY SEGMENT</span>
<span class="s4"># =============================================================================</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">+ </span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">100</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;MARKETING RECOMMENDATIONS BY SEGMENT&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">100</span><span class="s2">)</span>

<span class="s1">marketing_recommendations </span><span class="s2">= []</span>

<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">FINAL_K</span><span class="s2">):</span>
    <span class="s1">profile </span><span class="s2">= </span><span class="s1">segment_profiles</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n{</span><span class="s3">'=' </span><span class="s2">* </span><span class="s5">100</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;SEGMENT </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">: </span><span class="s0">{</span><span class="s1">segment_names</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s3">'=' </span><span class="s2">* </span><span class="s5">100</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;Size: </span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Size'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">,</span><span class="s0">} </span><span class="s3">customers (</span><span class="s0">{</span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Size_Pct'</span><span class="s2">]</span><span class="s0">:</span><span class="s3">.1f</span><span class="s0">}</span><span class="s3">% of total)&quot;</span><span class="s2">)</span>

    <span class="s4"># Determine marketing strategy based on segment characteristics</span>
    <span class="s1">age </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Avg_Age'</span><span class="s2">]</span>
    <span class="s1">income_pct </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_Income50K'</span><span class="s2">]</span>
    <span class="s1">capital_pct </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_HasCapital'</span><span class="s2">]</span>
    <span class="s1">education_pct </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_HighEd'</span><span class="s2">]</span>
    <span class="s1">employed_pct </span><span class="s2">= </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_FullTime'</span><span class="s2">]</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n</span><span class="s3">Key Characteristics:&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;  - Average Age: </span><span class="s0">{</span><span class="s1">age</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">} </span><span class="s3">years&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;  - </span><span class="s0">{</span><span class="s1">income_pct</span><span class="s0">:</span><span class="s3">.1f</span><span class="s0">}</span><span class="s3">% earn over $50,000&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;  - </span><span class="s0">{</span><span class="s1">capital_pct</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% have investment income&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;  - </span><span class="s0">{</span><span class="s1">education_pct</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% have Bachelor's degree or higher&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;  - </span><span class="s0">{</span><span class="s1">employed_pct</span><span class="s0">:</span><span class="s3">.0f</span><span class="s0">}</span><span class="s3">% employed full-time&quot;</span><span class="s2">)</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n</span><span class="s3">Marketing Strategy:&quot;</span><span class="s2">)</span>

    <span class="s4"># Children/Youth segment</span>
    <span class="s0">if </span><span class="s1">age </span><span class="s2">&lt; </span><span class="s5">20</span><span class="s2">:</span>
        <span class="s1">strategy </span><span class="s2">= </span><span class="s3">&quot;YOUTH/FAMILY SEGMENT&quot;</span>
        <span class="s1">products </span><span class="s2">= [</span><span class="s3">&quot;Educational products&quot;</span><span class="s2">, </span><span class="s3">&quot;Children's services&quot;</span><span class="s2">, </span><span class="s3">&quot;Family packages&quot;</span><span class="s2">, </span><span class="s3">&quot;Youth programs&quot;</span><span class="s2">]</span>
        <span class="s1">channels </span><span class="s2">= [</span><span class="s3">&quot;Parents (email, social media)&quot;</span><span class="s2">, </span><span class="s3">&quot;Schools&quot;</span><span class="s2">, </span><span class="s3">&quot;Family events&quot;</span><span class="s2">]</span>
        <span class="s1">messaging </span><span class="s2">= [</span><span class="s3">&quot;Family-friendly&quot;</span><span class="s2">, </span><span class="s3">&quot;Educational value&quot;</span><span class="s2">, </span><span class="s3">&quot;Safe and trusted&quot;</span><span class="s2">]</span>

    <span class="s4"># Seniors/Retirees</span>
    <span class="s0">elif </span><span class="s1">age </span><span class="s2">&gt; </span><span class="s5">55</span><span class="s2">:</span>
        <span class="s1">strategy </span><span class="s2">= </span><span class="s3">&quot;SENIOR/RETIREMENT SEGMENT&quot;</span>
        <span class="s1">products </span><span class="s2">= [</span><span class="s3">&quot;Retirement planning&quot;</span><span class="s2">, </span><span class="s3">&quot;Health insurance&quot;</span><span class="s2">, </span><span class="s3">&quot;Travel packages&quot;</span><span class="s2">, </span><span class="s3">&quot;Fixed-income products&quot;</span><span class="s2">]</span>
        <span class="s1">channels </span><span class="s2">= [</span><span class="s3">&quot;Traditional mail&quot;</span><span class="s2">, </span><span class="s3">&quot;Email&quot;</span><span class="s2">, </span><span class="s3">&quot;Phone&quot;</span><span class="s2">, </span><span class="s3">&quot;Community centers&quot;</span><span class="s2">]</span>
        <span class="s1">messaging </span><span class="s2">= [</span><span class="s3">&quot;Security&quot;</span><span class="s2">, </span><span class="s3">&quot;Comfort&quot;</span><span class="s2">, </span><span class="s3">&quot;Peace of mind&quot;</span><span class="s2">, </span><span class="s3">&quot;Reliability&quot;</span><span class="s2">]</span>

    <span class="s4"># High-income professionals</span>
    <span class="s0">elif </span><span class="s1">income_pct </span><span class="s2">&gt; </span><span class="s5">20 </span><span class="s0">or </span><span class="s1">capital_pct </span><span class="s2">&gt; </span><span class="s5">20</span><span class="s2">:</span>
        <span class="s1">strategy </span><span class="s2">= </span><span class="s3">&quot;PREMIUM/AFFLUENT SEGMENT&quot;</span>
        <span class="s1">products </span><span class="s2">= [</span><span class="s3">&quot;Premium services&quot;</span><span class="s2">, </span><span class="s3">&quot;Investment products&quot;</span><span class="s2">, </span><span class="s3">&quot;Luxury goods&quot;</span><span class="s2">, </span><span class="s3">&quot;Wealth management&quot;</span><span class="s2">]</span>
        <span class="s1">channels </span><span class="s2">= [</span><span class="s3">&quot;Personalized email&quot;</span><span class="s2">, </span><span class="s3">&quot;Direct mail&quot;</span><span class="s2">, </span><span class="s3">&quot;VIP events&quot;</span><span class="s2">, </span><span class="s3">&quot;Account managers&quot;</span><span class="s2">]</span>
        <span class="s1">messaging </span><span class="s2">= [</span><span class="s3">&quot;Exclusivity&quot;</span><span class="s2">, </span><span class="s3">&quot;Quality&quot;</span><span class="s2">, </span><span class="s3">&quot;Status&quot;</span><span class="s2">, </span><span class="s3">&quot;Premium experience&quot;</span><span class="s2">]</span>

    <span class="s4"># Working professionals</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">strategy </span><span class="s2">= </span><span class="s3">&quot;WORKING PROFESSIONAL SEGMENT&quot;</span>
        <span class="s1">products </span><span class="s2">= [</span><span class="s3">&quot;Career services&quot;</span><span class="s2">, </span><span class="s3">&quot;Practical financial products&quot;</span><span class="s2">, </span><span class="s3">&quot;Convenience services&quot;</span><span class="s2">, </span><span class="s3">&quot;Value offerings&quot;</span><span class="s2">]</span>
        <span class="s1">channels </span><span class="s2">= [</span><span class="s3">&quot;Email&quot;</span><span class="s2">, </span><span class="s3">&quot;Mobile apps&quot;</span><span class="s2">, </span><span class="s3">&quot;Social media&quot;</span><span class="s2">, </span><span class="s3">&quot;Online platforms&quot;</span><span class="s2">]</span>
        <span class="s1">messaging </span><span class="s2">= [</span><span class="s3">&quot;Convenience&quot;</span><span class="s2">, </span><span class="s3">&quot;Efficiency&quot;</span><span class="s2">, </span><span class="s3">&quot;Value&quot;</span><span class="s2">, </span><span class="s3">&quot;Work-life balance&quot;</span><span class="s2">]</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;  ** </span><span class="s0">{</span><span class="s1">strategy</span><span class="s0">} </span><span class="s3">**&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n  </span><span class="s3">Recommended Products:&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">products</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;    - </span><span class="s0">{</span><span class="s1">p</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n  </span><span class="s3">Recommended Channels:&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">channels</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;    - </span><span class="s0">{</span><span class="s1">c</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n  </span><span class="s3">Key Messaging Themes:&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">m </span><span class="s0">in </span><span class="s1">messaging</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;    - </span><span class="s0">{</span><span class="s1">m</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

    <span class="s4"># Cross-sell opportunities</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n  </span><span class="s3">Cross-Sell Opportunities:&quot;</span><span class="s2">)</span>
    <span class="s1">cross_sells </span><span class="s2">= []</span>

    <span class="s0">if </span><span class="s1">capital_pct </span><span class="s2">&gt; </span><span class="s5">10</span><span class="s2">:</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Investment advisory services&quot;</span><span class="s2">)</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Tax optimization services&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Pct_Married'</span><span class="s2">] &gt; </span><span class="s5">50</span><span class="s2">:</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Family insurance products&quot;</span><span class="s2">)</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Joint account services&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">education_pct </span><span class="s2">&gt; </span><span class="s5">20</span><span class="s2">:</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Professional development programs&quot;</span><span class="s2">)</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Premium tech products&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">employed_pct </span><span class="s2">&gt; </span><span class="s5">30</span><span class="s2">:</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Workplace benefits programs&quot;</span><span class="s2">)</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Commuter services&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">age </span><span class="s2">&gt; </span><span class="s5">55</span><span class="s2">:</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Estate planning services&quot;</span><span class="s2">)</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Healthcare products&quot;</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">cross_sells</span><span class="s2">:</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;General loyalty programs&quot;</span><span class="s2">)</span>
        <span class="s1">cross_sells</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;Referral incentives&quot;</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">cs </span><span class="s0">in </span><span class="s1">cross_sells</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;    - </span><span class="s0">{</span><span class="s1">cs</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

    <span class="s4"># Save recommendation</span>
    <span class="s1">marketing_recommendations</span><span class="s2">.</span><span class="s1">append</span><span class="s2">({</span>
        <span class="s3">'Segment'</span><span class="s2">: </span><span class="s1">i</span><span class="s2">,</span>
        <span class="s3">'Name'</span><span class="s2">: </span><span class="s1">segment_names</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
        <span class="s3">'Size'</span><span class="s2">: </span><span class="s1">profile</span><span class="s2">[</span><span class="s3">'Size'</span><span class="s2">],</span>
        <span class="s3">'Strategy'</span><span class="s2">: </span><span class="s1">strategy</span><span class="s2">,</span>
        <span class="s3">'Products'</span><span class="s2">: </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">products</span><span class="s2">),</span>
        <span class="s3">'Channels'</span><span class="s2">: </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">channels</span><span class="s2">),</span>
        <span class="s3">'Messaging'</span><span class="s2">: </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">messaging</span><span class="s2">)</span>
    <span class="s2">})</span>

<span class="s4"># Save marketing recommendations</span>
<span class="s1">df_marketing </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">marketing_recommendations</span><span class="s2">)</span>
<span class="s1">df_marketing</span><span class="s2">.</span><span class="s1">to_csv</span><span class="s2">(</span><span class="s3">'data/marketing_recommendations.csv'</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">+ </span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">100</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Marketing recommendations saved: data/marketing_recommendations.csv&quot;</span><span class="s2">)</span>
<span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;=&quot; </span><span class="s2">* </span><span class="s5">100</span><span class="s2">)</span>

</pre>
</body>
</html>